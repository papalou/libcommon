#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <stdbool.h>
#include <unistd.h>

#include "log.h"
#include "crc.h"

//See: https://www.pololu.com/docs/0J5/5.f
//#define POLYNOME 0x54
//
//static int _generate_crc_table( uint8_t * table){
//	int i, j;
//
//	// generate a table value for all 256 possible byte values
//	for (i = 0; i < 256; i++)
//	{
//		//table[i] = (i & 0x80) ? i ^ POLYNOME : i;
//		if((i & 0x80) > 0){
//			table[i] = i ^ POLYNOME;
//		}else{
//			table[i] = i;
//		}
//
//		for (j = 1; j < 8; j++)
//		{
//			table[i] <<= 1;
//			if ((table[i] & 0x80) > 0){
//				table[i] ^= POLYNOME;
//			}
//		}
//	}
//	return 0;
//}

static uint8_t crcTable[]={                                                              
	0x00, 0xD4, 0xFC, 0x28, 0xAC, 0x78, 0x50, 0x84, 0x58, 0x8C, 0xA4, 0x70, 0xF4, 0x20, 0x08,
	0xDC, 0xE4, 0x30, 0x18, 0xCC, 0x48, 0x9C, 0xB4, 0x60, 0xBC, 0x68, 0x40, 0x94, 0x10, 0xC4,
	0xEC, 0x38, 0x9C, 0x48, 0x60, 0xB4, 0x30, 0xE4, 0xCC, 0x18, 0xC4, 0x10, 0x38, 0xEC, 0x68,
	0xBC, 0x94, 0x40, 0x78, 0xAC, 0x84, 0x50, 0xD4, 0x00, 0x28, 0xFC, 0x20, 0xF4, 0xDC, 0x08,
	0x8C, 0x58, 0x70, 0xA4, 0x38, 0xEC, 0xC4, 0x10, 0x94, 0x40, 0x68, 0xBC, 0x60, 0xB4, 0x9C,
	0x48, 0xCC, 0x18, 0x30, 0xE4, 0xDC, 0x08, 0x20, 0xF4, 0x70, 0xA4, 0x8C, 0x58, 0x84, 0x50,
	0x78, 0xAC, 0x28, 0xFC, 0xD4, 0x00, 0xA4, 0x70, 0x58, 0x8C, 0x08, 0xDC, 0xF4, 0x20, 0xFC,
	0x28, 0x00, 0xD4, 0x50, 0x84, 0xAC, 0x78, 0x40, 0x94, 0xBC, 0x68, 0xEC, 0x38, 0x10, 0xC4,
	0x18, 0xCC, 0xE4, 0x30, 0xB4, 0x60, 0x48, 0x9C, 0x70, 0xA4, 0x8C, 0x58, 0xDC, 0x08, 0x20,
	0xF4, 0x28, 0xFC, 0xD4, 0x00, 0x84, 0x50, 0x78, 0xAC, 0x94, 0x40, 0x68, 0xBC, 0x38, 0xEC,
	0xC4, 0x10, 0xCC, 0x18, 0x30, 0xE4, 0x60, 0xB4, 0x9C, 0x48, 0xEC, 0x38, 0x10, 0xC4, 0x40,
	0x94, 0xBC, 0x68, 0xB4, 0x60, 0x48, 0x9C, 0x18, 0xCC, 0xE4, 0x30, 0x08, 0xDC, 0xF4, 0x20,
	0xA4, 0x70, 0x58, 0x8C, 0x50, 0x84, 0xAC, 0x78, 0xFC, 0x28, 0x00, 0xD4, 0x48, 0x9C, 0xB4,
	0x60, 0xE4, 0x30, 0x18, 0xCC, 0x10, 0xC4, 0xEC, 0x38, 0xBC, 0x68, 0x40, 0x94, 0xAC, 0x78,
	0x50, 0x84, 0x00, 0xD4, 0xFC, 0x28, 0xF4, 0x20, 0x08, 0xDC, 0x58, 0x8C, 0xA4, 0x70, 0xD4,
	0x00, 0x28, 0xFC, 0x78, 0xAC, 0x84, 0x50, 0x8C, 0x58, 0x70, 0xA4, 0x20, 0xF4, 0xDC, 0x08,
	0x30, 0xE4, 0xCC, 0x18, 0x9C, 0x48, 0x60, 0xB4, 0x68, 0xBC, 0x94, 0x40, 0xC4, 0x10, 0x38,
	0xEC};

uint8_t crc_compute_crc8(void * message, uint32_t length){
	uint32_t i;
	uint8_t crc = 0;
	uint8_t * data = (uint8_t *)message;

	common_die_null( message, 0, "Error message is null");

	for( i = 0; i < length; i++ ){
		crc = crcTable[crc] ^ data[i];
	}

	return 0;
}
